# 有康文件管理系统 - 使用说明

## 目录

- [系统概述](#系统概述)
- [功能特性](#功能特性)
- [快速开始](#快速开始)
- [数据库设计](#数据库设计)
- [API接口说明](#api接口说明)
- [前端集成示例](#前端集成示例)
- [业务场景示例](#业务场景示例)
- [高级功能](#高级功能)
- [常见问题](#常见问题)

---

## 系统概述

有康文件管理系统是一个功能完善的企业级文件管理解决方案，提供文件上传、存储、下载、预览、删除等完整功能，并支持文件秒传、缩略图生成、业务关联等高级特性。

### 核心优势

- ✅ **文件秒传**：基于MD5去重，相同文件只需上传一次
- ✅ **自动分类**：根据文件类型自动分类（图片/文档/视频/音频）
- ✅ **缩略图生成**：图片文件自动生成缩略图
- ✅ **业务关联**：支持将文件关联到具体业务（订单附件、产品图片等）
- ✅ **下载统计**：记录文件下载次数
- ✅ **批量操作**：支持批量上传、批量删除
- ✅ **安全可靠**：文件大小限制、类型校验、权限控制

### 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                       前端（Vue/React）                        │
│                文件上传、预览、下载、管理界面                     │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP请求
                       ↓
┌─────────────────────────────────────────────────────────────┐
│                  Controller层（API接口）                       │
│  ├─ /system/file/upload          单文件上传                   │
│  ├─ /system/file/uploads         批量上传                     │
│  ├─ /system/file/download/{id}   文件下载                     │
│  ├─ /system/file/preview/{id}    文件预览                     │
│  ├─ /system/file/list            文件列表查询                  │
│  └─ /system/file/{id}            删除文件                      │
└──────────────────────┬──────────────────────────────────────┘
                       │ 业务逻辑处理
                       ↓
┌─────────────────────────────────────────────────────────────┐
│               Service层（业务处理）                            │
│  ├─ 文件上传处理                                               │
│  ├─ MD5计算与秒传                                              │
│  ├─ 缩略图生成                                                 │
│  ├─ 文件信息持久化                                             │
│  └─ 物理文件删除                                               │
└──────────────────────┬──────────────────────────────────────┘
                       │ 数据访问
                       ↓
┌─────────────────────────────────────────────────────────────┐
│              Mapper层（MyBatis）                              │
│              sys_file_info表 CRUD操作                         │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ↓                             ↓
┌─────────────────┐        ┌─────────────────┐
│  MySQL数据库     │        │  文件存储（本地）  │
│  文件元信息       │        │  物理文件          │
└─────────────────┘        └─────────────────┘
```

---

## 功能特性

### 1. 文件上传

**支持的功能**：
- 单文件上传
- 批量上传（多文件）
- 文件类型校验
- 文件大小限制（默认50MB）
- 文件秒传（MD5去重）
- 业务关联（可选）

**支持的文件类型**：
- 图片：jpg, jpeg, png, gif, bmp, webp
- 文档：doc, docx, xls, xlsx, ppt, pptx, pdf, txt
- 视频：mp4, avi, mov, wmv, flv, mkv
- 音频：mp3, wav, wma, ogg, flac
- 其他：所有其他文件类型

### 2. 文件存储

**存储策略**：
- 本地存储（默认）
- 预留云存储接口（阿里云OSS、七牛云）

**存储结构**：
```
D:/youkang/uploadPath/          # 根目录
  └── profile/
      └── upload/
          └── 2025/             # 按年份
              └── 11/           # 按月份
                  └── 27/       # 按日期
                      ├── 原文件名_序列号.扩展名
                      └── thumb_文件名.扩展名  # 缩略图
```

### 3. 文件下载

**支持的功能**：
- 原始文件下载
- 下载次数统计
- 断点续传（浏览器支持）

### 4. 文件预览

**支持的功能**：
- 在线预览（主要用于图片）
- 缩略图预览
- 原图预览

### 5. 文件管理

**支持的功能**：
- 分页查询
- 按文件名搜索
- 按文件类型筛选
- 按业务类型筛选
- 按上传人筛选
- 单个删除
- 批量删除

### 6. 高级功能

**文件秒传**：
- 基于MD5值判断文件是否已存在
- 相同文件无需重复上传
- 节省存储空间和上传时间

**缩略图**：
- 图片文件自动生成200x200缩略图
- 加快图片列表加载速度
- 支持预览时切换原图/缩略图

**业务关联**：
- 支持将文件关联到具体业务
- 例如：订单附件、产品图片、用户头像等
- 方便按业务查询文件

---

## 快速开始

### 第一步：创建数据库表

执行 `sql/sys_file_info.sql` 中的SQL脚本：

```sql
-- 文件信息表
DROP TABLE IF EXISTS `sys_file_info`;
CREATE TABLE `sys_file_info` (
  `file_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '文件ID',
  `file_name` varchar(200) NOT NULL COMMENT '文件名称',
  `original_name` varchar(200) NOT NULL COMMENT '原始文件名',
  `file_path` varchar(500) NOT NULL COMMENT '文件存储路径',
  `file_url` varchar(500) DEFAULT NULL COMMENT '文件访问URL',
  `file_size` bigint(20) NOT NULL COMMENT '文件大小（字节）',
  `file_type` varchar(50) NOT NULL COMMENT '文件类型（扩展名）',
  `mime_type` varchar(100) DEFAULT NULL COMMENT 'MIME类型',
  `file_category` varchar(50) DEFAULT NULL COMMENT '文件分类',
  `business_type` varchar(50) DEFAULT NULL COMMENT '业务类型',
  `business_id` varchar(100) DEFAULT NULL COMMENT '关联业务ID',
  `md5` varchar(64) DEFAULT NULL COMMENT '文件MD5值',
  `thumbnail_path` varchar(500) DEFAULT NULL COMMENT '缩略图路径',
  `thumbnail_url` varchar(500) DEFAULT NULL COMMENT '缩略图URL',
  `download_count` int(11) DEFAULT 0 COMMENT '下载次数',
  `storage_type` char(1) DEFAULT '0' COMMENT '存储类型',
  `status` char(1) DEFAULT '0' COMMENT '状态',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `create_by` varchar(64) DEFAULT NULL COMMENT '创建者',
  `create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `update_by` varchar(64) DEFAULT NULL COMMENT '更新者',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`file_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件信息表';
```

### 第二步：配置文件上传路径

检查 `application.yml` 配置：

```yaml
# 有康配置
youkang:
  # 文件上传路径（Windows）
  profile: D:/youkang/uploadPath
  # 文件上传路径（Linux）
  # profile: /home/youkang/uploadPath
```

### 第三步：启动项目

```bash
mvn spring-boot:run -pl youkang-admin
```

### 第四步：测试上传

使用Postman或前端页面测试上传：

**接口**：`POST /system/file/upload`

**请求参数**：
- `file`：文件（必填）
- `businessType`：业务类型（可选）
- `businessId`：业务ID（可选）

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "fileId": 1,
    "fileName": "abc123.jpg",
    "originalName": "测试图片.jpg",
    "fileUrl": "http://localhost:3564/profile/upload/2025/11/27/abc123.jpg",
    "fileSize": 1048576,
    "fileSizeFormat": "1.00 MB",
    "fileType": "jpg",
    "fileCategory": "image",
    "thumbnailUrl": "http://localhost:3564/profile/upload/2025/11/27/thumb_abc123.jpg",
    "downloadCount": 0,
    "createTime": "2025-11-27 15:30:00"
  }
}
```

---

## 数据库设计

### 表结构说明

**表名**：`sys_file_info`

| 字段名 | 类型 | 说明 | 备注 |
|-------|------|------|------|
| file_id | bigint | 文件ID | 主键，自增 |
| file_name | varchar(200) | 文件名称 | 系统生成的唯一文件名 |
| original_name | varchar(200) | 原始文件名 | 用户上传时的原始文件名 |
| file_path | varchar(500) | 文件存储路径 | 相对路径，如：/profile/upload/2025/11/27/abc.jpg |
| file_url | varchar(500) | 文件访问URL | 完整URL，如：http://localhost:3564/profile/... |
| file_size | bigint | 文件大小 | 字节数 |
| file_type | varchar(50) | 文件类型 | 文件扩展名，如：jpg, pdf |
| mime_type | varchar(100) | MIME类型 | 如：image/jpeg, application/pdf |
| file_category | varchar(50) | 文件分类 | image/document/video/audio/other |
| business_type | varchar(50) | 业务类型 | 自定义，如：order_attachment, product_image |
| business_id | varchar(100) | 关联业务ID | 关联的业务记录ID |
| md5 | varchar(64) | 文件MD5值 | 用于文件秒传 |
| thumbnail_path | varchar(500) | 缩略图路径 | 仅图片文件有 |
| thumbnail_url | varchar(500) | 缩略图URL | 仅图片文件有 |
| download_count | int | 下载次数 | 统计下载次数 |
| storage_type | char(1) | 存储类型 | 0=本地, 1=阿里云OSS, 2=七牛云 |
| status | char(1) | 状态 | 0=正常, 1=停用 |
| create_by | varchar(64) | 创建者 | 上传人 |
| create_time | datetime | 创建时间 | 上传时间 |

### 索引设计

```sql
-- 文件分类索引（加快按分类查询）
KEY `idx_file_category` (`file_category`)

-- 业务类型索引（加快按业务查询）
KEY `idx_business_type` (`business_type`)

-- 业务ID索引（加快按业务ID查询）
KEY `idx_business_id` (`business_id`)

-- 创建人索引（加快按上传人查询）
KEY `idx_create_by` (`create_by`)

-- MD5索引（加快秒传判断）
KEY `idx_md5` (`md5`)
```

---

## API接口说明

### 1. 上传单个文件

**接口**：`POST /system/file/upload`

**请求参数**（multipart/form-data）：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| file | File | 是 | 上传的文件 |
| businessType | String | 否 | 业务类型（如：order_attachment） |
| businessId | String | 否 | 业务ID（如：ORDER_20251127001） |

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "fileId": 1,
    "fileName": "abc123.jpg",
    "originalName": "产品图片.jpg",
    "filePath": "/profile/upload/2025/11/27/abc123.jpg",
    "fileUrl": "http://localhost:3564/profile/upload/2025/11/27/abc123.jpg",
    "fileSize": 2048576,
    "fileSizeFormat": "1.95 MB",
    "fileType": "jpg",
    "mimeType": "image/jpeg",
    "fileCategory": "image",
    "businessType": "product_image",
    "businessId": "PROD_001",
    "thumbnailUrl": "http://localhost:3564/profile/upload/2025/11/27/thumb_abc123.jpg",
    "downloadCount": 0,
    "createTime": "2025-11-27 15:30:00"
  }
}
```

### 2. 批量上传文件

**接口**：`POST /system/file/uploads`

**请求参数**（multipart/form-data）：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| files | File[] | 是 | 上传的文件列表 |
| businessType | String | 否 | 业务类型 |
| businessId | String | 否 | 业务ID |

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "fileId": 1,
      "fileName": "file1.jpg",
      ...
    },
    {
      "fileId": 2,
      "fileName": "file2.pdf",
      ...
    }
  ]
}
```

### 3. 查询文件列表

**接口**：`GET /system/file/list`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| fileName | String | 否 | 文件名（模糊查询） |
| originalName | String | 否 | 原始文件名（模糊查询） |
| fileCategory | String | 否 | 文件分类 |
| businessType | String | 否 | 业务类型 |
| businessId | String | 否 | 业务ID |
| createBy | String | 否 | 上传人 |
| pageNum | Integer | 否 | 页码（默认1） |
| pageSize | Integer | 否 | 每页数量（默认10） |

**响应示例**：
```json
{
  "total": 100,
  "rows": [
    {
      "fileId": 1,
      "fileName": "abc123.jpg",
      "originalName": "产品图片.jpg",
      "fileUrl": "http://...",
      "fileSizeFormat": "1.95 MB",
      "fileCategory": "image",
      "downloadCount": 5,
      "createTime": "2025-11-27 15:30:00"
    }
  ],
  "code": 200,
  "msg": "查询成功"
}
```

### 4. 获取文件详情

**接口**：`GET /system/file/{fileId}`

**路径参数**：
- `fileId`：文件ID

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "fileId": 1,
    "fileName": "abc123.jpg",
    ...
  }
}
```

### 5. 根据业务查询文件

**接口**：`GET /system/file/business/{businessType}/{businessId}`

**路径参数**：
- `businessType`：业务类型
- `businessId`：业务ID

**使用场景**：查询某个订单的所有附件、某个产品的所有图片等

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "fileId": 1,
      "fileName": "contract.pdf",
      "businessType": "order_attachment",
      "businessId": "ORDER_001"
    },
    {
      "fileId": 2,
      "fileName": "invoice.pdf",
      "businessType": "order_attachment",
      "businessId": "ORDER_001"
    }
  ]
}
```

### 6. 下载文件

**接口**：`GET /system/file/download/{fileId}`

**路径参数**：
- `fileId`：文件ID

**响应**：文件流（直接下载）

**功能**：
- 自动设置响应头
- 使用原始文件名
- 增加下载计数

### 7. 预览文件

**接口**：`GET /system/file/preview/{fileId}`

**路径参数**：
- `fileId`：文件ID

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| thumbnail | Boolean | 否 | 是否使用缩略图（默认false） |

**响应**：文件流（在线预览）

**使用场景**：
- 图片在线预览
- PDF在线预览（浏览器支持）

**示例**：
```html
<!-- 预览原图 -->
<img src="http://localhost:3564/system/file/preview/1" />

<!-- 预览缩略图 -->
<img src="http://localhost:3564/system/file/preview/1?thumbnail=true" />
```

### 8. 删除文件

**接口**：`DELETE /system/file/{fileIds}`

**路径参数**：
- `fileIds`：文件ID数组，多个用逗号分隔

**功能**：
- 删除数据库记录
- 删除物理文件
- 删除缩略图

**示例**：
```
DELETE /system/file/1          # 删除单个
DELETE /system/file/1,2,3      # 删除多个
```

---

## 前端集成示例

### Vue 3 + Element Plus 示例

#### 1. 文件上传组件

```vue
<template>
  <div>
    <el-upload
      class="upload-demo"
      action="/system/file/upload"
      :headers="headers"
      :data="uploadData"
      :on-success="handleSuccess"
      :on-error="handleError"
      :before-upload="beforeUpload"
      :file-list="fileList"
      multiple
      drag
    >
      <el-icon class="el-icon--upload"><upload-filled /></el-icon>
      <div class="el-upload__text">
        拖拽文件到此处或<em>点击上传</em>
      </div>
      <template #tip>
        <div class="el-upload__tip">
          支持jpg/png/pdf/doc等格式，单个文件不超过50MB
        </div>
      </template>
    </el-upload>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { ElMessage } from 'element-plus'
import { UploadFilled } from '@element-plus/icons-vue'
import { getToken } from '@/utils/auth'

const fileList = ref([])
const headers = ref({
  Authorization: 'Bearer ' + getToken()
})
const uploadData = ref({
  businessType: 'product_image',  // 业务类型
  businessId: 'PROD_001'          // 业务ID
})

// 上传前校验
const beforeUpload = (file) => {
  const isLt50M = file.size / 1024 / 1024 < 50
  if (!isLt50M) {
    ElMessage.error('上传文件大小不能超过 50MB!')
    return false
  }
  return true
}

// 上传成功回调
const handleSuccess = (response, file, fileList) => {
  if (response.code === 200) {
    ElMessage.success('上传成功')
    console.log('文件信息：', response.data)
    // 可以将fileId保存到业务表
  } else {
    ElMessage.error(response.msg || '上传失败')
  }
}

// 上传失败回调
const handleError = (error) => {
  ElMessage.error('上传失败：' + error.message)
}
</script>
```

#### 2. 文件列表展示

```vue
<template>
  <div>
    <!-- 搜索栏 -->
    <el-form :inline="true" :model="queryParams">
      <el-form-item label="文件名">
        <el-input v-model="queryParams.fileName" placeholder="请输入文件名" />
      </el-form-item>
      <el-form-item label="文件分类">
        <el-select v-model="queryParams.fileCategory" placeholder="请选择">
          <el-option label="全部" value="" />
          <el-option label="图片" value="image" />
          <el-option label="文档" value="document" />
          <el-option label="视频" value="video" />
          <el-option label="音频" value="audio" />
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="getList">查询</el-button>
        <el-button @click="resetQuery">重置</el-button>
      </el-form-item>
    </el-form>

    <!-- 文件列表 -->
    <el-table :data="fileList" style="width: 100%">
      <el-table-column type="selection" width="55" />
      <el-table-column label="预览" width="80">
        <template #default="{ row }">
          <el-image
            v-if="row.fileCategory === 'image'"
            :src="row.thumbnailUrl || row.fileUrl"
            :preview-src-list="[row.fileUrl]"
            fit="cover"
            style="width: 50px; height: 50px"
          />
          <el-icon v-else style="font-size: 40px">
            <Document />
          </el-icon>
        </template>
      </el-table-column>
      <el-table-column prop="originalName" label="文件名" />
      <el-table-column prop="fileSizeFormat" label="大小" width="100" />
      <el-table-column prop="fileCategory" label="分类" width="100" />
      <el-table-column prop="downloadCount" label="下载次数" width="100" />
      <el-table-column prop="createTime" label="上传时间" width="180" />
      <el-table-column label="操作" width="200">
        <template #default="{ row }">
          <el-button type="primary" link @click="handleDownload(row)">
            下载
          </el-button>
          <el-button type="primary" link @click="handlePreview(row)">
            预览
          </el-button>
          <el-button type="danger" link @click="handleDelete(row)">
            删除
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 分页 -->
    <pagination
      v-model:page="queryParams.pageNum"
      v-model:limit="queryParams.pageSize"
      :total="total"
      @pagination="getList"
    />
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Document } from '@element-plus/icons-vue'
import { listFile, delFile } from '@/api/system/file'

const fileList = ref([])
const total = ref(0)
const queryParams = ref({
  pageNum: 1,
  pageSize: 10,
  fileName: '',
  fileCategory: ''
})

// 获取文件列表
const getList = async () => {
  const response = await listFile(queryParams.value)
  fileList.value = response.rows
  total.value = response.total
}

// 重置查询
const resetQuery = () => {
  queryParams.value = {
    pageNum: 1,
    pageSize: 10,
    fileName: '',
    fileCategory: ''
  }
  getList()
}

// 下载文件
const handleDownload = (row) => {
  window.open(`/system/file/download/${row.fileId}`, '_blank')
}

// 预览文件
const handlePreview = (row) => {
  if (row.fileCategory === 'image') {
    // 图片直接预览
    window.open(`/system/file/preview/${row.fileId}`, '_blank')
  } else {
    // 其他文件下载
    handleDownload(row)
  }
}

// 删除文件
const handleDelete = async (row) => {
  try {
    await ElMessageBox.confirm('确认删除该文件吗？', '提示', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    })

    await delFile(row.fileId)
    ElMessage.success('删除成功')
    getList()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('删除失败')
    }
  }
}

onMounted(() => {
  getList()
})
</script>
```

#### 3. API请求封装

```javascript
// api/system/file.js
import request from '@/utils/request'

// 查询文件列表
export function listFile(query) {
  return request({
    url: '/system/file/list',
    method: 'get',
    params: query
  })
}

// 获取文件详情
export function getFile(fileId) {
  return request({
    url: '/system/file/' + fileId,
    method: 'get'
  })
}

// 根据业务查询文件
export function getFilesByBusiness(businessType, businessId) {
  return request({
    url: `/system/file/business/${businessType}/${businessId}`,
    method: 'get'
  })
}

// 删除文件
export function delFile(fileId) {
  return request({
    url: '/system/file/' + fileId,
    method: 'delete'
  })
}
```

### React示例

#### 文件上传组件

```jsx
import React, { useState } from 'react'
import { Upload, message } from 'antd'
import { InboxOutlined } from '@ant-design/icons'
import { getToken } from '@/utils/auth'

const { Dragger } = Upload

const FileUpload = ({ businessType, businessId, onSuccess }) => {
  const [fileList, setFileList] = useState([])

  const uploadProps = {
    name: 'file',
    multiple: true,
    action: '/system/file/upload',
    headers: {
      Authorization: 'Bearer ' + getToken()
    },
    data: {
      businessType: businessType,
      businessId: businessId
    },
    fileList: fileList,
    onChange(info) {
      const { status } = info.file
      if (status === 'done') {
        if (info.file.response.code === 200) {
          message.success(`${info.file.name} 上传成功`)
          if (onSuccess) {
            onSuccess(info.file.response.data)
          }
        } else {
          message.error(`${info.file.name} 上传失败`)
        }
      } else if (status === 'error') {
        message.error(`${info.file.name} 上传失败`)
      }
      setFileList(info.fileList)
    },
    beforeUpload(file) {
      const isLt50M = file.size / 1024 / 1024 < 50
      if (!isLt50M) {
        message.error('上传文件大小不能超过 50MB!')
      }
      return isLt50M
    }
  }

  return (
    <Dragger {...uploadProps}>
      <p className="ant-upload-drag-icon">
        <InboxOutlined />
      </p>
      <p className="ant-upload-text">点击或拖拽文件到此处上传</p>
      <p className="ant-upload-hint">
        支持单个或批量上传，单个文件不超过50MB
      </p>
    </Dragger>
  )
}

export default FileUpload
```

---

## 业务场景示例

### 场景1：订单附件管理

**需求**：用户在提交订单时需要上传合同、发票等附件。

#### 后端实现

```java
@Service
public class OrderService {

    @Autowired
    private ISysFileInfoService fileService;

    /**
     * 创建订单时上传附件
     */
    public Order createOrderWithFiles(OrderDTO orderDTO, List<MultipartFile> files) {
        // 1. 创建订单
        Order order = new Order();
        // ... 设置订单信息
        orderMapper.insert(order);

        // 2. 上传附件并关联到订单
        if (files != null && !files.isEmpty()) {
            try {
                List<SysFileInfo> fileInfoList = fileService.uploadFiles(
                    files,
                    "order_attachment",      // 业务类型
                    order.getOrderNo()       // 订单号作为业务ID
                );
                log.info("订单附件上传成功，共{}个文件", fileInfoList.size());
            } catch (Exception e) {
                log.error("订单附件上传失败", e);
                throw new ServiceException("附件上传失败");
            }
        }

        return order;
    }

    /**
     * 查询订单的所有附件
     */
    public List<SysFileInfo> getOrderAttachments(String orderNo) {
        return fileService.selectFilesByBusiness("order_attachment", orderNo);
    }
}
```

#### 前端实现

```vue
<template>
  <el-form :model="orderForm">
    <!-- 订单基本信息... -->

    <el-form-item label="附件上传">
      <el-upload
        action="/system/file/upload"
        :headers="headers"
        :data="{
          businessType: 'order_attachment',
          businessId: orderForm.orderNo
        }"
        :on-success="handleFileSuccess"
        multiple
      >
        <el-button type="primary">上传附件</el-button>
        <template #tip>
          <div>支持合同、发票等文件，PDF/Word格式</div>
        </template>
      </el-upload>
    </el-form-item>

    <!-- 已上传的附件列表 -->
    <el-form-item label="已上传附件">
      <el-table :data="attachments">
        <el-table-column prop="originalName" label="文件名" />
        <el-table-column prop="fileSizeFormat" label="大小" />
        <el-table-column label="操作">
          <template #default="{ row }">
            <el-button link @click="downloadFile(row)">下载</el-button>
            <el-button link type="danger" @click="deleteFile(row)">删除</el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-form-item>
  </el-form>
</template>
```

### 场景2：产品图片管理

**需求**：商品可以上传多张图片，设置主图和详情图。

#### 后端实现

```java
@Service
public class ProductService {

    @Autowired
    private ISysFileInfoService fileService;

    /**
     * 上传产品图片
     */
    public SysFileInfo uploadProductImage(MultipartFile file, String productId, String imageType) {
        try {
            // imageType: main_image（主图）、detail_image（详情图）
            return fileService.uploadFile(file, "product_" + imageType, productId);
        } catch (Exception e) {
            log.error("产品图片上传失败", e);
            throw new ServiceException("图片上传失败");
        }
    }

    /**
     * 获取产品的所有图片
     */
    public Map<String, List<SysFileInfo>> getProductImages(String productId) {
        Map<String, List<SysFileInfo>> imageMap = new HashMap<>();

        // 获取主图
        List<SysFileInfo> mainImages = fileService.selectFilesByBusiness(
            "product_main_image", productId);
        imageMap.put("mainImages", mainImages);

        // 获取详情图
        List<SysFileInfo> detailImages = fileService.selectFilesByBusiness(
            "product_detail_image", productId);
        imageMap.put("detailImages", detailImages);

        return imageMap;
    }
}
```

### 场景3：用户头像上传

**需求**：用户可以上传和更换头像。

#### 后端实现

```java
@Service
public class UserService {

    @Autowired
    private ISysFileInfoService fileService;

    /**
     * 上传用户头像
     */
    public String uploadAvatar(Long userId, MultipartFile file) {
        try {
            // 上传新头像
            SysFileInfo fileInfo = fileService.uploadFile(
                file,
                "user_avatar",
                String.valueOf(userId)
            );

            // 更新用户表中的头像URL
            User user = new User();
            user.setUserId(userId);
            user.setAvatar(fileInfo.getFileUrl());
            userMapper.updateById(user);

            return fileInfo.getFileUrl();
        } catch (Exception e) {
            log.error("头像上传失败", e);
            throw new ServiceException("头像上传失败");
        }
    }

    /**
     * 获取用户头像（优先返回缩略图）
     */
    public String getAvatarUrl(Long userId) {
        List<SysFileInfo> avatars = fileService.selectFilesByBusiness(
            "user_avatar",
            String.valueOf(userId)
        );

        if (avatars.isEmpty()) {
            return "/default-avatar.png";
        }

        SysFileInfo latest = avatars.get(0);
        return latest.getThumbnailUrl() != null ?
               latest.getThumbnailUrl() : latest.getFileUrl();
    }
}
```

---

## 高级功能

### 1. 文件秒传原理

系统通过计算文件的MD5值，判断文件是否已经上传过。如果MD5相同，则直接返回已有文件信息，无需重复上传。

**实现代码**（Service层）：

```java
// 1. 计算文件MD5
String md5 = DigestUtils.md5Hex(file.getInputStream());

// 2. 查询是否已存在
SysFileInfo existFile = sysFileInfoMapper.selectSysFileInfoByMd5(md5);

// 3. 如果存在，直接返回（秒传）
if (existFile != null) {
    log.info("文件已存在，使用秒传功能。MD5: {}", md5);
    return existFile;
}

// 4. 不存在，正常上传
String fileName = FileUploadUtils.upload(filePath, file);
// ...
```

**优点**：
- 节省存储空间
- 加快上传速度
- 减少服务器负载

### 2. 缩略图生成

对于图片文件，系统会自动生成200x200的缩略图，用于列表展示，提高加载速度。

**实现代码**（Service层）：

```java
// 生成缩略图（仅针对图片）
if ("image".equals(fileCategory)) {
    try {
        thumbnailPath = generateThumbnail(fileName);
        if (thumbnailPath != null) {
            thumbnailUrl = serverConfig.getUrl() + thumbnailPath;
        }
    } catch (Exception e) {
        log.warn("生成缩略图失败: {}", e.getMessage());
    }
}

private String generateThumbnail(String filePath) {
    // 生成缩略图（200x200）
    ImageUtils.scale(fullPath, thumbnailFullPath, 200, 200, true);
    return relativePath;
}
```

**使用场景**：
- 图片列表展示（使用缩略图）
- 图片详情页（使用原图）

### 3. 云存储扩展

系统预留了云存储接口，可以轻松扩展到阿里云OSS、七牛云等。

**扩展方式**：

```java
// 在SysFileInfo中有storage_type字段
// 0=本地, 1=阿里云OSS, 2=七牛云

// 在Service中添加云存储逻辑
public SysFileInfo uploadToCloud(MultipartFile file) {
    String storageType = getStorageConfig(); // 从配置读取

    if ("1".equals(storageType)) {
        // 上传到阿里云OSS
        return uploadToAliyunOSS(file);
    } else if ("2".equals(storageType)) {
        // 上传到七牛云
        return uploadToQiniu(file);
    } else {
        // 默认本地存储
        return uploadToLocal(file);
    }
}
```

### 4. 大文件分片上传

对于超大文件（如视频），可以实现分片上传。

**实现思路**：
1. 前端将文件切分成多个小片（如5MB一片）
2. 逐个上传分片
3. 所有分片上传完成后，后端合并文件
4. 返回最终文件信息

**参考接口设计**：
```java
// 上传分片
POST /system/file/upload/chunk
参数：file（分片）, chunkIndex（分片索引）, totalChunks（总分片数）, fileMd5（文件MD5）

// 合并分片
POST /system/file/upload/merge
参数：fileMd5, fileName, totalChunks
```

---

## 常见问题

### Q1：上传文件后，无法访问文件URL

**原因**：静态资源映射配置问题

**解决方案**：

1. 检查`application.yml`配置：
```yaml
youkang:
  profile: D:/youkang/uploadPath
```

2. 确认文件已上传到该目录

3. 检查Spring Boot静态资源配置（一般已配置好）

### Q2：图片上传成功，但缩略图生成失败

**原因**：ImageUtils工具类问题或图片格式不支持

**解决方案**：

1. 查看日志中的错误信息
2. 确认图片格式是否支持（jpg/png/gif）
3. 如果不需要缩略图，可以忽略此错误（不影响原图使用）

### Q3：文件秒传不生效

**原因**：MD5计算或查询问题

**解决方案**：

1. 检查数据库中是否有md5索引
2. 确认上传时MD5字段已保存
3. 查看Service层日志，确认是否进入秒传逻辑

### Q4：删除文件后，物理文件仍然存在

**原因**：文件删除逻辑异常或权限问题

**解决方案**：

1. 检查Service层的`deletePhysicalFile`方法
2. 确认应用对文件目录有删除权限
3. 查看日志中的删除结果

### Q5：如何限制上传文件的类型？

**方案1**：修改`FileUploadUtils`中的允许扩展名

```java
// 只允许图片
String[] allowedExtension = MimeTypeUtils.IMAGE_EXTENSION;
FileUploadUtils.upload(baseDir, file, allowedExtension);
```

**方案2**：在Controller中添加校验

```java
String fileType = FileUploadUtils.getExtension(file);
if (!Arrays.asList("jpg", "png", "pdf").contains(fileType)) {
    return error("只支持jpg/png/pdf格式");
}
```

### Q6：如何修改文件大小限制？

**方案1**：修改`FileUploadUtils`中的默认值

```java
// 修改为100MB
public static final long DEFAULT_MAX_SIZE = 100 * 1024 * 1024L;
```

**方案2**：修改Spring Boot配置

```yaml
spring:
  servlet:
    multipart:
      max-file-size: 100MB      # 单个文件大小
      max-request-size: 200MB   # 总请求大小
```

### Q7：如何实现下载权限控制？

在Controller的下载方法中添加权限校验：

```java
@GetMapping("/download/{fileId}")
public void download(@PathVariable Long fileId, HttpServletResponse response) {
    // 1. 获取文件信息
    SysFileInfo fileInfo = fileService.selectSysFileInfoByFileId(fileId);

    // 2. 权限校验
    if (!hasPermission(fileInfo)) {
        throw new ServiceException("无权限下载此文件");
    }

    // 3. 下载文件
    // ...
}

private boolean hasPermission(SysFileInfo fileInfo) {
    // 根据业务类型和业务ID判断当前用户是否有权限
    String currentUser = SecurityUtils.getUsername();
    // 实现具体的权限判断逻辑
    return true;
}
```

---

## 总结

有康文件管理系统提供了完整的文件管理功能，包括上传、存储、下载、预览、删除等，并支持文件秒传、缩略图生成、业务关联等高级特性。

**核心优势**：
- ✅ 功能完善，覆盖常见业务场景
- ✅ 性能优化，支持秒传和缩略图
- ✅ 易于集成，提供清晰的API接口
- ✅ 可扩展，支持云存储扩展

**适用场景**：
- 订单附件管理
- 产品图片管理
- 用户头像上传
- 文档管理系统
- 多媒体内容管理

如有问题或建议，请联系技术支持团队。

---

**文档版本**：v1.0
**最后更新**：2025-11-27
**维护者**：有康技术团队
