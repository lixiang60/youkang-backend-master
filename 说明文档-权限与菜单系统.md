# 有康(YouKang)权限与菜单系统使用说明

> 版本：3.9.0
> 更新时间：2025-11-27

---

## 目录

1. [系统概述](#1-系统概述)
2. [权限系统详解](#2-权限系统详解)
3. [菜单系统详解](#3-菜单系统详解)
4. [数据权限系统](#4-数据权限系统)
5. [角色管理](#5-角色管理)
6. [权限检查使用指南](#6-权限检查使用指南)
7. [API接口说明](#7-api接口说明)
8. [开发最佳实践](#8-开发最佳实践)
9. [常见问题与注意事项](#9-常见问题与注意事项)

---

## 1. 系统概述

有康系统采用基于角色的访问控制（RBAC）模型，实现了完善的权限管理体系。系统通过JWT令牌进行身份认证，结合Spring Security实现细粒度的权限控制。

### 1.1 核心特性

- **RBAC权限模型**：用户-角色-菜单三层权限体系
- **JWT无状态认证**：基于令牌的认证机制，支持分布式部署
- **细粒度权限控制**：支持到按钮级别的权限控制
- **五级数据权限**：支持全部、自定义、本部门、本部门及下级、仅本人
- **动态菜单路由**：前端菜单根据用户权限动态生成
- **权限注解支持**：通过注解声明式进行权限控制

### 1.2 权限模型关系图

```
用户(SysUser)
    ↓ 1:N
用户角色关联(sys_user_role)
    ↓ N:1
角色(SysRole)
    ↓ 1:N
角色菜单关联(sys_role_menu)
    ↓ N:1
菜单/权限(SysMenu)
```

### 1.3 核心数据表

| 表名 | 说明 | 关键字段 |
|------|------|---------|
| `sys_user` | 用户表 | userId, userName, deptId, status |
| `sys_role` | 角色表 | roleId, roleName, roleKey, dataScope |
| `sys_menu` | 菜单权限表 | menuId, menuName, perms, menuType |
| `sys_user_role` | 用户角色关联 | userId, roleId |
| `sys_role_menu` | 角色菜单关联 | roleId, menuId |
| `sys_role_dept` | 角色部门关联 | roleId, deptId（数据权限使用） |

---

## 2. 权限系统详解

### 2.1 权限字符串格式

权限字符串采用**三级标识符**格式：`模块:功能:操作`

#### 标准格式示例

```
system:user:list          // 用户列表
system:user:add           // 新增用户
system:user:edit          // 编辑用户
system:user:remove        // 删除用户
system:user:export        // 导出用户
system:user:import        // 导入用户
system:user:resetPwd      // 重置密码

system:role:list          // 角色列表
system:role:add           // 新增角色
system:role:edit          // 编辑角色
system:role:remove        // 删除角色

system:menu:list          // 菜单列表
system:menu:add           // 新增菜单
system:menu:edit          // 编辑菜单
system:menu:remove        // 删除菜单

monitor:online:list       // 在线用户列表
monitor:online:forceLogout // 强制退出

tool:gen:list             // 代码生成列表
tool:gen:code             // 生成代码
tool:gen:preview          // 预览代码
```

#### 特殊权限标识

```
*:*:*                     // 全部权限（超级管理员）
admin                     // 超级管理员角色
```

### 2.2 权限服务 (PermissionService)

#### 核心方法说明

PermissionService在Spring容器中注册为`ss` Bean，可在SpEL表达式中使用`@ss`引用。

**文件位置**：`youkang-framework/src/main/java/com/youkang/framework/web/service/PermissionService.java`

```java
// 检查单个权限
boolean hasPermi(String permission)

// 检查多个权限（任意一个满足即可）
boolean hasAnyPermi(String permissions)  // 权限用逗号分隔

// 检查是否缺少某权限
boolean lacksPermi(String permission)

// 检查单个角色
boolean hasRole(String role)

// 检查多个角色（任意一个满足即可）
boolean hasAnyRoles(String roles)  // 角色用逗号分隔

// 检查是否缺少某角色
boolean lacksRole(String role)
```

#### 关键常量

```java
Constants.PERMISSION_DELIMETER = ","     // 权限分隔符
Constants.ROLE_DELIMETER = ","           // 角色分隔符
Constants.ALL_PERMISSION = "*:*:*"       // 全权限标识
Constants.SUPER_ADMIN = "admin"          // 超级管理员角色
```

### 2.3 权限检查机制

#### 权限获取流程

```
1. 用户登录
   ↓
2. SysLoginService.login() 验证用户身份
   ↓
3. SysPermissionService.getMenuPermission() 获取用户菜单权限
   ├─ 超级管理员 → 返回 "*:*:*"
   └─ 普通用户 → 查询用户所有角色的菜单权限
   ↓
4. SysPermissionService.getRolePermission() 获取用户角色权限
   ├─ 超级管理员 → 返回 "admin"
   └─ 普通用户 → 查询用户的所有角色标识
   ↓
5. 生成 LoginUser 对象（包含 permissions 和 roles 集合）
   ↓
6. TokenService.createToken() 生成JWT令牌
   ↓
7. 将 LoginUser 缓存到 Redis，令牌返回给客户端
   ↓
8. 客户端后续请求携带 Authorization: Bearer {token}
   ↓
9. JwtAuthenticationTokenFilter 验证令牌并恢复 LoginUser
   ↓
10. PermissionService 从 SecurityContext 获取 LoginUser 进行权限检查
```

#### SQL查询语句

菜单权限查询（`SysMenuMapper.xml`）：

```xml
<select id="selectMenuPermsByUserId" parameterType="Long" resultType="String">
    select distinct m.perms
    from sys_menu m
        left join sys_role_menu rm on m.menu_id = rm.menu_id
        left join sys_user_role ur on rm.role_id = ur.role_id
        left join sys_role r on r.role_id = ur.role_id
    where m.status = '0'
      and r.status = '0'
      and ur.user_id = #{userId}
</select>
```

角色标识查询（`SysRoleMapper.xml`）：

```xml
<select id="selectRolePermissionByUserId" parameterType="Long" resultType="String">
    select distinct r.role_key
    from sys_role r
        left join sys_user_role ur on ur.role_id = r.role_id
        left join sys_user u on u.user_id = ur.user_id
    where u.user_id = #{userId}
</select>
```

### 2.4 JWT令牌管理

#### 令牌配置

在`application.yml`中配置：

```yaml
token:
  header: Authorization           # 令牌自定义标识
  secret: abcdefghijklmnopqrstuvwxyz  # 令牌密钥
  expireTime: 30                  # 令牌有效期（分钟）
```

**安全建议**：生产环境请使用环境变量或密钥管理服务配置`token.secret`。

#### 令牌使用流程

**客户端请求携带令牌**：

```http
GET /system/user/list HTTP/1.1
Host: localhost:3564
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9...
```

**令牌验证过滤器**：

```
JwtAuthenticationTokenFilter（位置：youkang-framework/security/filter/）
    ↓
TokenService.getLoginUser(request)
    ↓
1. 从请求头获取 Authorization
2. 解析 JWT 令牌获取 UUID
3. 从 Redis 获取缓存的 LoginUser
4. 检查令牌是否过期
5. 自动刷新令牌过期时间（距离过期<20分钟时）
    ↓
将 LoginUser 包装为 UsernamePasswordAuthenticationToken
    ↓
设置到 SecurityContextHolder 中
    ↓
请求继续处理（已认证状态）
```

#### LoginUser 模型

```java
public class LoginUser implements UserDetails {
    private Long userId;              // 用户ID
    private Long deptId;              // 部门ID
    private String token;             // 令牌UUID
    private Long loginTime;           // 登录时间
    private Long expireTime;          // 过期时间
    private String ipaddr;            // 登录IP地址
    private String loginLocation;     // 登录地点
    private String browser;           // 浏览器类型
    private String os;                // 操作系统
    private Set<String> permissions;  // 权限标识集合
    private SysUser user;             // 用户信息
}
```

---

## 3. 菜单系统详解

### 3.1 菜单类型

系统支持三种菜单类型（存储在`menu_type`字段）：

| 类型 | 代码 | 说明 | 使用场景 |
|------|------|------|---------|
| 目录 | M | 菜单目录 | 一级菜单，通常作为菜单分组 |
| 菜单 | C | 菜单项 | 具体的页面菜单，对应一个前端路由 |
| 按钮 | F | 按钮权限 | 页面内的操作按钮权限，不显示在菜单树中 |

### 3.2 SysMenu 实体结构

**文件位置**：`youkang-common/src/main/java/com/youkang/common/core/domain/entity/SysMenu.java`

```java
public class SysMenu extends BaseEntity {
    // 基本信息
    private Long menuId;              // 菜单ID
    private String menuName;          // 菜单名称
    private Long parentId;            // 父菜单ID（0表示根菜单）
    private Integer orderNum;         // 显示顺序

    // 路由信息
    private String path;              // 路由地址
    private String component;         // 组件路径
    private String routeName;         // 路由名称
    private String query;             // 路由参数

    // 菜单类型和状态
    private String menuType;          // 菜单类型（M目录 C菜单 F按钮）
    private String visible;           // 菜单显示状态（0显示 1隐藏）
    private String status;            // 菜单状态（0正常 1停用）

    // 权限和显示
    private String perms;             // 权限标识（多个用逗号分隔）
    private String icon;              // 菜单图标

    // 外链和缓存
    private String isFrame;           // 是否外链（0是 1否）
    private String isCache;           // 是否缓存（0缓存 1不缓存）

    // 树结构
    private List<SysMenu> children;   // 子菜单列表
}
```

### 3.3 菜单字段说明

#### 路由相关字段

| 字段 | 说明 | 示例 |
|------|------|------|
| path | 路由地址 | `/system/user` |
| component | 组件路径 | `system/user/index` |
| routeName | 路由名称 | `User` |
| query | 路由参数 | `{"id": 1, "name": "test"}` |

#### 权限字段 (perms)

支持多个权限标识，用逗号分隔：

```
单权限：system:user:list
多权限：system:user:list,system:user:query,system:user:add
```

#### 显示控制字段

| 字段 | 说明 | 值 |
|------|------|-----|
| visible | 菜单显示状态 | 0-显示，1-隐藏 |
| status | 菜单状态 | 0-正常，1-停用 |
| isFrame | 是否外链 | 0-是，1-否 |
| isCache | 是否缓存 | 0-缓存，1-不缓存 |

### 3.4 菜单服务接口

**文件位置**：`youkang-system/src/main/java/com/youkang/system/service/ISysMenuService.java`

#### 核心方法

```java
public interface ISysMenuService {
    // 查询菜单列表
    List<SysMenu> selectMenuList(Long userId);
    List<SysMenu> selectMenuList(SysMenu menu, Long userId);

    // 查询单个菜单
    SysMenu selectMenuById(Long menuId);

    // 查询用户权限
    Set<String> selectMenuPermsByUserId(Long userId);
    Set<String> selectMenuPermsByRoleId(Long roleId);

    // 构建菜单树
    List<SysMenu> selectMenuTreeByUserId(Long userId);
    List<SysMenu> buildMenuTree(List<SysMenu> menus);
    List<TreeSelect> buildMenuTreeSelect(List<SysMenu> menus);

    // 构建前端路由
    List<RouterVo> buildMenus(List<SysMenu> menus);

    // 菜单管理
    int insertMenu(SysMenu menu);
    int updateMenu(SysMenu menu);
    int deleteMenuById(Long menuId);

    // 验证菜单
    boolean checkMenuNameUnique(SysMenu menu);
    boolean hasChildByMenuId(Long menuId);
    boolean checkMenuExistRole(Long menuId);

    // 角色相关
    List<Long> selectMenuListByRoleId(Long roleId);
}
```

### 3.5 菜单树构建

#### 构建流程

```
1. selectMenuTreeByUserId(userId)
   ↓
2. 查询用户可见的所有菜单（包括按钮）
   ├─ 超级管理员：查询所有菜单
   └─ 普通用户：根据角色查询关联菜单
   ↓
3. buildMenuTree(menus)
   ├─ 找出所有根菜单（parentId = 0）
   ├─ 递归构建每个根菜单的子树
   └─ 按 orderNum 排序
   ↓
4. 返回树形菜单结构
```

#### 树形结构示例

```json
[
  {
    "menuId": 1,
    "menuName": "系统管理",
    "parentId": 0,
    "menuType": "M",
    "children": [
      {
        "menuId": 100,
        "menuName": "用户管理",
        "parentId": 1,
        "menuType": "C",
        "perms": "system:user:list",
        "children": [
          {
            "menuId": 1001,
            "menuName": "用户新增",
            "parentId": 100,
            "menuType": "F",
            "perms": "system:user:add"
          },
          {
            "menuId": 1002,
            "menuName": "用户编辑",
            "parentId": 100,
            "menuType": "F",
            "perms": "system:user:edit"
          }
        ]
      }
    ]
  }
]
```

### 3.6 前端路由构建

`buildMenus()`方法将菜单树转换为前端路由配置（Vue Router格式）：

```java
// 返回的 RouterVo 结构
public class RouterVo {
    private String name;              // 路由名称
    private String path;              // 路由地址
    private boolean hidden;           // 是否隐藏
    private String redirect;          // 重定向地址
    private String component;         // 组件路径
    private String query;             // 路由参数
    private boolean alwaysShow;       // 总是显示
    private MetaVo meta;              // 路由元信息
    private List<RouterVo> children;  // 子路由
}

// MetaVo 结构
public class MetaVo {
    private String title;             // 标题
    private String icon;              // 图标
    private boolean noCache;          // 不缓存
    private String link;              // 外链地址
}
```

---

## 4. 数据权限系统

### 4.1 数据权限概述

数据权限用于控制用户可以查看和操作哪些数据范围，通过`@DataScope`注解实现自动SQL过滤。

### 4.2 数据权限级别

系统定义了五个数据权限级别（存储在`sys_role.data_scope`字段）：

| 级别 | 代码 | 说明 | 数据范围 |
|------|------|------|---------|
| 全部数据权限 | 1 | 可查看所有数据 | 不添加任何过滤条件 |
| 自定义数据权限 | 2 | 可查看指定部门数据 | 根据角色关联的部门进行过滤 |
| 本部门数据权限 | 3 | 可查看本部门数据 | 过滤出用户所在部门的数据 |
| 本部门及以下数据权限 | 4 | 可查看本部门及子部门数据 | 过滤出用户所在部门及子部门数据 |
| 仅本人数据权限 | 5 | 只能查看自己的数据 | 过滤出创建人为当前用户的数据 |

### 4.3 @DataScope 注解

**文件位置**：`youkang-common/src/main/java/com/youkang/common/annotation/DataScope.java`

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface DataScope {
    /**
     * 部门表的别名
     */
    public String deptAlias() default "";

    /**
     * 用户表的别名
     */
    public String userAlias() default "";

    /**
     * 权限字符（用于多角色匹配模式）
     */
    public String permission() default "";
}
```

### 4.4 使用方式

#### 在Service层使用

```java
@Service
public class SysUserServiceImpl implements ISysUserService {

    @Override
    @DataScope(deptAlias = "d", userAlias = "u")
    public List<SysUser> selectUserList(SysUser user) {
        return userMapper.selectUserList(user);
    }
}
```

#### Mapper SQL配置

```xml
<select id="selectUserList" parameterType="SysUser" resultMap="SysUserResult">
    select u.user_id, u.user_name, u.nick_name, u.dept_id, d.dept_name
    from sys_user u
        left join sys_dept d on u.dept_id = d.dept_id
    where u.del_flag = '0'
    ${params.dataScope}
</select>
```

**关键点**：
- SQL中必须包含`${params.dataScope}`占位符
- 表别名必须与注解中的`deptAlias`和`userAlias`一致

### 4.5 数据权限处理流程

```
1. 方法调用 @DataScope 注解的服务方法
   ↓
2. DataScopeAspect 拦截方法调用（AOP切面）
   ↓
3. 从 SecurityContext 获取当前登录用户 LoginUser
   ↓
4. 获取用户的所有角色
   ↓
5. 遍历角色，根据 dataScope 字段生成SQL条件
   ├─ 1（全部数据）→ 不添加任何条件
   ├─ 2（自定义）→ dept_id IN (角色关联的部门ID)
   ├─ 3（本部门）→ dept_id = 用户部门ID
   ├─ 4（本部门及以下）→ dept_id IN (用户部门及子部门ID)
   └─ 5（仅本人）→ create_by = 用户名
   ↓
6. 将生成的SQL条件设置到 BaseEntity.params.dataScope 中
   ↓
7. MyBatis执行SQL时，${params.dataScope} 被替换为实际的过滤条件
   ↓
8. 返回过滤后的数据
```

### 4.6 SQL条件生成示例

假设用户部门ID为105，用户名为"zhangsan"：

```sql
-- 全部数据权限（1）
-- 不添加条件

-- 自定义数据权限（2）- 假设角色关联部门100,101
AND (d.dept_id IN (100,101))

-- 本部门数据权限（3）
AND (d.dept_id = 105)

-- 本部门及以下数据权限（4）- 假设105的子部门有106,107
AND (d.dept_id IN (105,106,107) OR d.ancestors LIKE '%,105,%')

-- 仅本人数据权限（5）
AND (u.create_by = 'zhangsan')
```

### 4.7 数据权限配置

#### 角色数据权限配置

在角色管理界面配置：

1. 编辑角色
2. 选择数据权限范围（1-5）
3. 如果选择"自定义数据权限"（2），需勾选允许查看的部门
4. 保存后，该角色下的所有用户将应用此数据权限

#### 数据权限表（sys_role_dept）

```sql
-- 存储角色的自定义数据权限（仅当 data_scope = 2 时使用）
CREATE TABLE sys_role_dept (
    role_id   BIGINT(20) NOT NULL COMMENT '角色ID',
    dept_id   BIGINT(20) NOT NULL COMMENT '部门ID',
    PRIMARY KEY (role_id, dept_id)
);
```

---

## 5. 角色管理

### 5.1 SysRole 实体

**文件位置**：`youkang-common/src/main/java/com/youkang/common/core/domain/entity/SysRole.java`

```java
public class SysRole extends BaseEntity {
    private Long roleId;                    // 角色ID
    private String roleName;                // 角色名称
    private String roleKey;                 // 角色权限字符串（用于角色检查）
    private Integer roleSort;               // 角色排序

    private String dataScope;               // 数据范围（1-5）
    private boolean menuCheckStrictly;      // 菜单树选择是否关联显示
    private boolean deptCheckStrictly;      // 部门树选择是否关联显示

    private String status;                  // 角色状态（0正常 1停用）
    private boolean flag = false;           // 用户是否存在此角色标识（非数据库字段）

    private Long[] menuIds;                 // 角色菜单权限
    private Long[] deptIds;                 // 角色部门权限（数据权限）
    private Set<String> permissions;        // 角色菜单权限集合（非数据库字段）
}
```

### 5.2 角色类型

#### 超级管理员角色

```java
// 角色ID = 1，角色标识 = "admin"
roleId = 1L
roleKey = "admin"
```

**特点**：
- 拥有所有权限`*:*:*`
- 拥有所有菜单访问权限
- 数据权限默认为"全部数据权限"（1）
- 无法删除和修改

#### 普通角色

通过角色菜单关联表（sys_role_menu）配置权限：

```sql
INSERT INTO sys_role_menu (role_id, menu_id) VALUES (2, 1);
INSERT INTO sys_role_menu (role_id, menu_id) VALUES (2, 100);
INSERT INTO sys_role_menu (role_id, menu_id) VALUES (2, 1001);
```

### 5.3 角色权限分配

#### 分配菜单权限

```
1. 编辑角色
   ↓
2. 在菜单权限树中勾选菜单和按钮
   ↓
3. 保存角色
   ↓
4. 系统删除该角色的所有菜单关联
   ↓
5. 重新插入勾选的菜单关联
   ↓
6. 该角色的用户下次登录时获取新权限
```

#### 分配数据权限

```
1. 编辑角色
   ↓
2. 选择数据权限范围（1-5）
   ↓
3. 如果选择"自定义数据权限"（2），勾选部门
   ↓
4. 保存角色
   ↓
5. 用户查询数据时自动应用数据权限过滤
```

### 5.4 用户角色分配

#### 单用户分配角色

```
1. 编辑用户
   ↓
2. 在角色列表中勾选角色
   ↓
3. 保存用户
   ↓
4. 系统删除该用户的所有角色关联
   ↓
5. 重新插入勾选的角色关联
   ↓
6. 用户下次登录时获取新角色权限
```

#### 批量分配用户

```
1. 进入角色管理 → 分配用户
   ↓
2. 在用户列表中选择要分配的用户
   ↓
3. 批量添加或移除用户
   ↓
4. 系统更新用户角色关联表
```

---

## 6. 权限检查使用指南

### 6.1 在Controller中使用权限注解

#### @PreAuthorize 注解

在方法上使用`@PreAuthorize`进行权限检查：

```java
@RestController
@RequestMapping("/system/user")
public class SysUserController extends BaseController {

    /**
     * 查询用户列表
     */
    @PreAuthorize("@ss.hasPermi('system:user:list')")
    @GetMapping("/list")
    public TableDataInfo list(SysUser user) {
        startPage();
        List<SysUser> list = userService.selectUserList(user);
        return getDataTable(list);
    }

    /**
     * 新增用户
     */
    @PreAuthorize("@ss.hasPermi('system:user:add')")
    @Log(title = "用户管理", businessType = BusinessType.INSERT)
    @PostMapping
    public AjaxResult add(@Validated @RequestBody SysUser user) {
        return toAjax(userService.insertUser(user));
    }

    /**
     * 修改用户
     */
    @PreAuthorize("@ss.hasPermi('system:user:edit')")
    @Log(title = "用户管理", businessType = BusinessType.UPDATE)
    @PutMapping
    public AjaxResult edit(@Validated @RequestBody SysUser user) {
        return toAjax(userService.updateUser(user));
    }

    /**
     * 删除用户
     */
    @PreAuthorize("@ss.hasPermi('system:user:remove')")
    @Log(title = "用户管理", businessType = BusinessType.DELETE)
    @DeleteMapping("/{userIds}")
    public AjaxResult remove(@PathVariable Long[] userIds) {
        return toAjax(userService.deleteUserByIds(userIds));
    }
}
```

### 6.2 权限表达式

#### 单个权限检查

```java
@PreAuthorize("@ss.hasPermi('system:user:add')")
```

#### 多个权限检查（任意一个满足）

```java
@PreAuthorize("@ss.hasAnyPermi('system:user:add,system:user:edit')")
```

#### 缺少权限检查

```java
@PreAuthorize("@ss.lacksPermi('system:user:remove')")
```

#### 角色检查

```java
@PreAuthorize("@ss.hasRole('admin')")
```

#### 多个角色检查（任意一个满足）

```java
@PreAuthorize("@ss.hasAnyRoles('admin,editor')")
```

#### 复合条件

```java
// 需要同时满足权限和角色
@PreAuthorize("@ss.hasPermi('system:user:add') && @ss.hasRole('admin')")

// 需要满足权限或角色任意一个
@PreAuthorize("@ss.hasPermi('system:user:add') || @ss.hasRole('admin')")

// 复杂条件
@PreAuthorize("@ss.hasRole('admin') || (@ss.hasPermi('system:user:edit') && @ss.hasRole('editor'))")
```

### 6.3 在代码中动态检查权限

#### 注入 PermissionService

```java
@Service
public class SomeService {

    @Autowired
    private PermissionService permissionService;

    public void someMethod() {
        // 检查权限
        if (permissionService.hasPermi("system:user:add")) {
            // 有新增权限，执行操作
        }

        // 检查角色
        if (permissionService.hasRole("admin")) {
            // 是管理员，执行特殊操作
        }

        // 检查多个权限
        if (permissionService.hasAnyPermi("system:user:add,system:user:edit")) {
            // 有新增或编辑权限
        }
    }
}
```

### 6.4 匿名访问（跳过权限检查）

使用`@Anonymous`注解标记公开接口：

```java
@Anonymous
@GetMapping("/public/info")
public AjaxResult publicInfo() {
    return success("公开信息");
}
```

**注意**：
- `@Anonymous`注解需要在`SecurityConfig`中配置白名单
- 该接口不会进行JWT令牌验证
- 适用于验证码、登录、注册等公开接口

### 6.5 权限检查失败处理

#### 返回结果

权限检查失败时，系统返回403状态码：

```json
{
  "code": 403,
  "msg": "没有权限，请联系管理员授权"
}
```

#### 全局异常处理

**文件位置**：`youkang-framework/src/main/java/com/youkang/framework/web/exception/GlobalExceptionHandler.java`

```java
@ExceptionHandler(AccessDeniedException.class)
public AjaxResult handleAccessDeniedException(AccessDeniedException e) {
    log.error(e.getMessage(), e);
    return AjaxResult.error(HttpStatus.FORBIDDEN, "没有权限，请联系管理员授权");
}
```

---

## 7. API接口说明

### 7.1 登录认证接口

#### 获取验证码

```http
GET /captchaImage
```

**响应**：

```json
{
  "code": 200,
  "msg": "操作成功",
  "uuid": "a9c7f4e5-...",
  "img": "data:image/png;base64,..."
}
```

#### 用户登录

```http
POST /login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123",
  "code": "1234",
  "uuid": "a9c7f4e5-..."
}
```

**响应**：

```json
{
  "code": 200,
  "msg": "操作成功",
  "token": "eyJhbGciOiJIUzUxMiJ9..."
}
```

#### 获取用户信息

```http
GET /getInfo
Authorization: Bearer {token}
```

**响应**：

```json
{
  "code": 200,
  "msg": "操作成功",
  "user": {
    "userId": 1,
    "userName": "admin",
    "nickName": "管理员",
    "deptId": 103
  },
  "roles": ["admin"],
  "permissions": ["*:*:*"]
}
```

#### 获取路由信息

```http
GET /getRouters
Authorization: Bearer {token}
```

**响应**：返回前端路由配置（根据用户权限动态生成）

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "name": "System",
      "path": "/system",
      "component": "Layout",
      "meta": {
        "title": "系统管理",
        "icon": "system"
      },
      "children": [...]
    }
  ]
}
```

### 7.2 菜单管理接口

**Controller位置**：`youkang-admin/src/main/java/com/youkang/web/controller/system/SysMenuController.java`

#### 查询菜单列表

```http
GET /system/menu/list
Authorization: Bearer {token}

Query参数：
- menuName: 菜单名称（可选）
- status: 菜单状态（可选）
```

**权限要求**：`system:menu:list`

**响应**：

```json
{
  "code": 200,
  "msg": "查询成功",
  "data": [
    {
      "menuId": 1,
      "menuName": "系统管理",
      "parentId": 0,
      "orderNum": 1,
      "path": "system",
      "component": "",
      "menuType": "M",
      "visible": "0",
      "status": "0",
      "perms": "",
      "icon": "system"
    }
  ]
}
```

#### 查询菜单详情

```http
GET /system/menu/{menuId}
Authorization: Bearer {token}
```

**权限要求**：`system:menu:query`

#### 获取菜单下拉树

```http
GET /system/menu/treeselect
Authorization: Bearer {token}
```

**无权限要求**（内部使用）

**响应**：

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "id": 1,
      "label": "系统管理",
      "children": [
        {
          "id": 100,
          "label": "用户管理"
        }
      ]
    }
  ]
}
```

#### 加载角色菜单树

```http
GET /system/menu/roleMenuTreeselect/{roleId}
Authorization: Bearer {token}
```

**无权限要求**（内部使用）

**响应**：

```json
{
  "code": 200,
  "msg": "操作成功",
  "menus": [...],           // 所有菜单树
  "checkedKeys": [1, 100]   // 角色已勾选的菜单ID
}
```

#### 新增菜单

```http
POST /system/menu
Authorization: Bearer {token}
Content-Type: application/json

{
  "menuName": "测试菜单",
  "parentId": 0,
  "orderNum": 1,
  "path": "/test",
  "component": "test/index",
  "menuType": "C",
  "visible": "0",
  "status": "0",
  "perms": "test:menu:list",
  "icon": "example"
}
```

**权限要求**：`system:menu:add`

#### 修改菜单

```http
PUT /system/menu
Authorization: Bearer {token}
Content-Type: application/json

{
  "menuId": 100,
  "menuName": "用户管理（修改）",
  ...
}
```

**权限要求**：`system:menu:edit`

#### 删除菜单

```http
DELETE /system/menu/{menuId}
Authorization: Bearer {token}
```

**权限要求**：`system:menu:remove`

### 7.3 角色管理接口

**Controller位置**：`youkang-admin/src/main/java/com/youkang/web/controller/system/SysRoleController.java`

#### 查询角色列表

```http
GET /system/role/list
Authorization: Bearer {token}

Query参数：
- roleName: 角色名称（可选）
- roleKey: 角色权限字符（可选）
- status: 角色状态（可选）
- pageNum: 页码（可选）
- pageSize: 每页数量（可选）
```

**权限要求**：`system:role:list`

#### 查询角色详情

```http
GET /system/role/{roleId}
Authorization: Bearer {token}
```

**权限要求**：`system:role:query`

#### 新增角色

```http
POST /system/role
Authorization: Bearer {token}
Content-Type: application/json

{
  "roleName": "测试角色",
  "roleKey": "test",
  "roleSort": 3,
  "dataScope": "2",
  "status": "0",
  "menuIds": [1, 100, 1001],
  "deptIds": [100, 101]
}
```

**权限要求**：`system:role:add`

#### 修改角色

```http
PUT /system/role
Authorization: Bearer {token}
Content-Type: application/json

{
  "roleId": 100,
  "roleName": "测试角色（修改）",
  ...
}
```

**权限要求**：`system:role:edit`

#### 删除角色

```http
DELETE /system/role/{roleIds}
Authorization: Bearer {token}
```

**权限要求**：`system:role:remove`

#### 修改角色数据权限

```http
PUT /system/role/dataScope
Authorization: Bearer {token}
Content-Type: application/json

{
  "roleId": 100,
  "dataScope": "2",
  "deptIds": [100, 101, 102]
}
```

**权限要求**：`system:role:edit`

#### 修改角色状态

```http
PUT /system/role/changeStatus
Authorization: Bearer {token}
Content-Type: application/json

{
  "roleId": 100,
  "status": "1"
}
```

**权限要求**：`system:role:edit`

### 7.4 用户管理接口

**Controller位置**：`youkang-admin/src/main/java/com/youkang/web/controller/system/SysUserController.java`

#### 查询用户列表

```http
GET /system/user/list
Authorization: Bearer {token}

Query参数：
- userName: 用户账号（可选）
- phonenumber: 手机号（可选）
- status: 用户状态（可选）
- deptId: 部门ID（可选）
- pageNum: 页码（可选）
- pageSize: 每页数量（可选）
```

**权限要求**：`system:user:list`

**数据权限**：根据角色的数据权限范围自动过滤

#### 新增用户

```http
POST /system/user
Authorization: Bearer {token}
Content-Type: application/json

{
  "userName": "testuser",
  "nickName": "测试用户",
  "password": "123456",
  "phonenumber": "15800000000",
  "email": "test@example.com",
  "sex": "0",
  "status": "0",
  "deptId": 105,
  "postIds": [1],
  "roleIds": [2]
}
```

**权限要求**：`system:user:add`

#### 修改用户

```http
PUT /system/user
Authorization: Bearer {token}
Content-Type: application/json

{
  "userId": 100,
  "nickName": "测试用户（修改）",
  ...
}
```

**权限要求**：`system:user:edit`

#### 删除用户

```http
DELETE /system/user/{userIds}
Authorization: Bearer {token}
```

**权限要求**：`system:user:remove`

#### 重置用户密码

```http
PUT /system/user/resetPwd
Authorization: Bearer {token}
Content-Type: application/json

{
  "userId": 100,
  "password": "123456"
}
```

**权限要求**：`system:user:resetPwd`

---

## 8. 开发最佳实践

### 8.1 权限设计原则

#### 权限粒度

1. **模块级权限**：控制整个模块的访问
   ```
   system:user:*          // 用户管理模块所有权限
   ```

2. **功能级权限**：控制具体功能页面
   ```
   system:user:list       // 用户列表页面
   system:user:query      // 用户详情查询
   ```

3. **操作级权限**：控制具体操作按钮
   ```
   system:user:add        // 新增按钮
   system:user:edit       // 编辑按钮
   system:user:remove     // 删除按钮
   system:user:export     // 导出按钮
   ```

#### 权限命名规范

```
格式：模块:功能:操作

模块名：
- system      // 系统管理
- monitor     // 系统监控
- tool        // 系统工具
- business    // 业务模块

功能名：
- user        // 用户管理
- role        // 角色管理
- menu        // 菜单管理
- dept        // 部门管理

操作名：
- list        // 列表查询
- query       // 详情查询
- add         // 新增
- edit        // 修改
- remove      // 删除
- export      // 导出
- import      // 导入
```

### 8.2 菜单设计原则

#### 菜单层级结构

```
一级菜单（M-目录）
  └─ 二级菜单（C-菜单）
      └─ 按钮权限（F-按钮）
```

**示例**：

```
系统管理（M）
  ├─ 用户管理（C）- perms: system:user:list
  │   ├─ 用户新增（F）- perms: system:user:add
  │   ├─ 用户编辑（F）- perms: system:user:edit
  │   ├─ 用户删除（F）- perms: system:user:remove
  │   └─ 重置密码（F）- perms: system:user:resetPwd
  │
  ├─ 角色管理（C）- perms: system:role:list
  │   ├─ 角色新增（F）- perms: system:role:add
  │   ├─ 角色编辑（F）- perms: system:role:edit
  │   └─ 角色删除（F）- perms: system:role:remove
  │
  └─ 菜单管理（C）- perms: system:menu:list
      ├─ 菜单新增（F）- perms: system:menu:add
      ├─ 菜单编辑（F）- perms: system:menu:edit
      └─ 菜单删除（F）- perms: system:menu:remove
```

#### 菜单字段配置建议

| 菜单类型 | path | component | perms | visible |
|---------|------|-----------|-------|---------|
| 目录(M) | `/system` | Layout或空 | 空 | 0(显示) |
| 菜单(C) | `/system/user` | `system/user/index` | `system:user:list` | 0(显示) |
| 按钮(F) | 空 | 空 | `system:user:add` | 0(显示) |

### 8.3 数据权限使用建议

#### 何时使用数据权限

1. **需要部门级数据隔离**
   - 每个部门只能看到本部门数据
   - 例如：人事查看本部门员工信息

2. **需要分级数据管理**
   - 上级部门可以查看下级部门数据
   - 例如：总经理查看所有部门数据

3. **需要个人数据隔离**
   - 用户只能查看自己创建的数据
   - 例如：销售人员只能看到自己的订单

#### 数据权限配置步骤

1. **设计数据表**
   ```sql
   CREATE TABLE business_data (
       id BIGINT PRIMARY KEY,
       name VARCHAR(100),
       dept_id BIGINT,          -- 部门ID字段（必需）
       create_by VARCHAR(64),   -- 创建者（仅本人权限时必需）
       create_time DATETIME
   );
   ```

2. **配置Mapper**
   ```xml
   <select id="selectList" resultType="BusinessData">
       select d.id, d.name, d.dept_id, dept.dept_name
       from business_data d
           left join sys_dept dept on d.dept_id = dept.dept_id
       where d.del_flag = '0'
       ${params.dataScope}
   </select>
   ```

3. **添加@DataScope注解**
   ```java
   @Override
   @DataScope(deptAlias = "dept", userAlias = "d")
   public List<BusinessData> selectList(BusinessData data) {
       return mapper.selectList(data);
   }
   ```

4. **配置角色数据权限**
   - 在角色管理中选择数据权限范围
   - 如果是自定义权限，选择允许查看的部门

### 8.4 安全最佳实践

#### 1. 令牌安全

```yaml
# 生产环境配置
token:
  secret: ${TOKEN_SECRET:defaultSecret}  # 使用环境变量
  expireTime: 30
```

**建议**：
- 令牌密钥使用强随机字符串（至少32位）
- 生产环境通过环境变量注入，不要硬编码
- 定期更换令牌密钥

#### 2. 密码安全

```java
// 密码加密（BCrypt）
String password = SecurityUtils.encryptPassword(rawPassword);

// 密码验证
boolean matches = SecurityUtils.matchesPassword(rawPassword, encodedPassword);
```

**建议**：
- 用户密码必须使用BCrypt加密存储
- 强制用户设置强密码（长度、复杂度）
- 实施密码重试限制（默认5次）

#### 3. 接口防护

```java
// 防止重复提交
@RepeatSubmit
@PostMapping
public AjaxResult add(@RequestBody SysUser user) { }

// 限流
@RateLimiter(count = 5, time = 60)
@GetMapping("/list")
public TableDataInfo list(SysUser user) { }

// 操作日志
@Log(title = "用户管理", businessType = BusinessType.INSERT)
@PostMapping
public AjaxResult add(@RequestBody SysUser user) { }
```

#### 4. XSS防护

系统默认开启XSS过滤（配置在`application.yml`）：

```yaml
xss:
  enabled: true
  excludes: /system/notice  # 排除的URL
  urlPatterns: /system/*,/monitor/*,/tool/*  # 匹配的URL
```

#### 5. SQL注入防护

**使用参数化查询**：

```xml
<!-- 正确 -->
<select id="selectById" parameterType="Long">
    select * from sys_user where user_id = #{userId}
</select>

<!-- 错误 - 存在SQL注入风险 -->
<select id="selectById" parameterType="Long">
    select * from sys_user where user_id = ${userId}
</select>
```

**注意**：
- 使用`#{}`进行参数绑定
- 仅在必要时使用`${}`（如动态表名、字段名）
- 对`${}`参数进行严格校验和白名单过滤

### 8.5 Controller开发模板

```java
@RestController
@RequestMapping("/system/example")
public class SysExampleController extends BaseController {

    @Autowired
    private ISysExampleService exampleService;

    /**
     * 查询列表（支持分页）
     */
    @PreAuthorize("@ss.hasPermi('system:example:list')")
    @GetMapping("/list")
    public TableDataInfo list(SysExample example) {
        startPage();  // 启动分页
        List<SysExample> list = exampleService.selectExampleList(example);
        return getDataTable(list);  // 返回分页数据
    }

    /**
     * 查询详情
     */
    @PreAuthorize("@ss.hasPermi('system:example:query')")
    @GetMapping(value = "/{id}")
    public AjaxResult getInfo(@PathVariable("id") Long id) {
        return success(exampleService.selectExampleById(id));
    }

    /**
     * 新增
     */
    @PreAuthorize("@ss.hasPermi('system:example:add')")
    @Log(title = "示例管理", businessType = BusinessType.INSERT)
    @PostMapping
    public AjaxResult add(@Validated @RequestBody SysExample example) {
        return toAjax(exampleService.insertExample(example));
    }

    /**
     * 修改
     */
    @PreAuthorize("@ss.hasPermi('system:example:edit')")
    @Log(title = "示例管理", businessType = BusinessType.UPDATE)
    @PutMapping
    public AjaxResult edit(@Validated @RequestBody SysExample example) {
        return toAjax(exampleService.updateExample(example));
    }

    /**
     * 删除
     */
    @PreAuthorize("@ss.hasPermi('system:example:remove')")
    @Log(title = "示例管理", businessType = BusinessType.DELETE)
    @DeleteMapping("/{ids}")
    public AjaxResult remove(@PathVariable Long[] ids) {
        return toAjax(exampleService.deleteExampleByIds(ids));
    }
}
```

### 8.6 Service开发模板

```java
@Service
public class SysExampleServiceImpl implements ISysExampleService {

    @Autowired
    private SysExampleMapper exampleMapper;

    /**
     * 查询列表（应用数据权限）
     */
    @Override
    @DataScope(deptAlias = "d", userAlias = "e")
    public List<SysExample> selectExampleList(SysExample example) {
        return exampleMapper.selectExampleList(example);
    }

    /**
     * 查询详情
     */
    @Override
    public SysExample selectExampleById(Long id) {
        return exampleMapper.selectExampleById(id);
    }

    /**
     * 新增
     */
    @Override
    public int insertExample(SysExample example) {
        example.setCreateTime(DateUtils.getNowDate());
        return exampleMapper.insertExample(example);
    }

    /**
     * 修改
     */
    @Override
    public int updateExample(SysExample example) {
        example.setUpdateTime(DateUtils.getNowDate());
        return exampleMapper.updateExample(example);
    }

    /**
     * 批量删除
     */
    @Override
    public int deleteExampleByIds(Long[] ids) {
        return exampleMapper.deleteExampleByIds(ids);
    }
}
```

---

## 9. 常见问题与注意事项

### 9.1 权限问题

#### Q1：新增用户后无法登录？

**原因**：用户没有分配角色或角色没有分配菜单权限。

**解决**：
1. 检查用户是否已分配角色（sys_user_role表）
2. 检查角色是否已分配菜单（sys_role_menu表）
3. 确保角色和菜单状态为"正常"（status='0'）

#### Q2：用户有权限但仍提示"没有权限"？

**原因**：
1. 权限字符串不匹配
2. Redis缓存未更新
3. 令牌已过期

**解决**：
1. 检查菜单的`perms`字段与Controller的`@PreAuthorize`是否一致
2. 强制用户重新登录以刷新权限缓存
3. 清空Redis缓存：`redis-cli FLUSHALL`

#### Q3：超级管理员无法操作某些功能？

**原因**：Controller方法缺少权限注解或使用了错误的权限检查。

**解决**：
- 确保超级管理员的roleKey为"admin"且userId为1
- 检查PermissionService是否正确识别超级管理员

### 9.2 菜单问题

#### Q4：菜单树显示不正确？

**原因**：菜单的`parentId`配置错误或存在循环引用。

**解决**：
1. 检查菜单的`parentId`是否指向有效的父菜单
2. 确保不存在循环引用（A的父菜单是B，B的父菜单是A）
3. 根菜单的`parentId`必须为0

#### Q5：前端菜单与数据库不一致？

**原因**：前端缓存或Redis缓存未更新。

**解决**：
1. 清除浏览器缓存
2. 清除Redis中的菜单缓存
3. 重新登录

#### Q6：按钮权限不生效？

**原因**：前端未正确使用权限指令。

**解决**：
```vue
<!-- Vue 3 前端使用 v-hasPermi 指令 -->
<el-button
  v-hasPermi="['system:user:add']"
  @click="handleAdd">
  新增
</el-button>
```

### 9.3 数据权限问题

#### Q7：数据权限不生效？

**原因**：
1. 未添加`@DataScope`注解
2. SQL中缺少`${params.dataScope}`占位符
3. 表别名不匹配

**解决**：
```java
// Service方法
@DataScope(deptAlias = "d")  // 部门表别名
public List<SysUser> selectList(SysUser user) { }

// Mapper XML
<select id="selectList">
    select u.*, d.dept_name
    from sys_user u
        left join sys_dept d on u.dept_id = d.dept_id
    where u.del_flag = '0'
    ${params.dataScope}  <!-- 必须添加 -->
</select>
```

#### Q8：自定义数据权限无效？

**原因**：角色未关联部门（sys_role_dept表为空）。

**解决**：
1. 在角色管理界面编辑角色
2. 数据权限选择"自定义数据权限"
3. 勾选允许查看的部门并保存

#### Q9：数据权限过滤了不应该过滤的数据？

**原因**：多个角色的数据权限冲突。

**解决**：
- 系统取用户所有角色中权限范围最大的
- 权限优先级：全部数据(1) > 自定义(2) > 本部门及以下(4) > 本部门(3) > 仅本人(5)
- 检查用户的所有角色配置

### 9.4 令牌问题

#### Q10：令牌过期时间不正确？

**原因**：配置的`expireTime`单位是分钟，不是秒。

**解决**：
```yaml
token:
  expireTime: 30  # 30分钟，不是30秒
```

#### Q11：令牌验证失败？

**原因**：
1. 令牌已过期
2. 令牌密钥不匹配
3. Redis连接失败

**解决**：
1. 检查令牌是否在有效期内
2. 确保`token.secret`配置正确
3. 检查Redis服务是否正常运行

#### Q12：频繁要求重新登录？

**原因**：令牌过期时间太短或Redis缓存被清空。

**解决**：
1. 增加`token.expireTime`配置值
2. 检查Redis是否配置了自动过期策略
3. 确保Redis有足够的内存

### 9.5 性能问题

#### Q13：权限查询慢？

**原因**：权限查询涉及多表关联，数据量大时性能下降。

**优化方案**：
1. 为关联字段添加索引
```sql
CREATE INDEX idx_user_role_user_id ON sys_user_role(user_id);
CREATE INDEX idx_role_menu_role_id ON sys_role_menu(role_id);
```

2. 使用Redis缓存权限数据（系统已实现）

3. 避免频繁查询权限，利用已缓存的LoginUser

#### Q14：菜单树构建慢？

**原因**：菜单数量多，递归构建效率低。

**优化方案**：
1. 限制菜单层级（建议不超过3层）
2. 使用缓存存储菜单树
3. 前端按需加载菜单

### 9.6 开发注意事项

#### 1. 不要硬编码权限字符串

**错误示例**：
```java
if (permissionService.hasPermi("system:user:add")) { }
```

**正确示例**：
```java
public class PermConstants {
    public static final String SYSTEM_USER_ADD = "system:user:add";
}

if (permissionService.hasPermi(PermConstants.SYSTEM_USER_ADD)) { }
```

#### 2. 权限粒度要适中

**过细**：为每个字段设置权限（不推荐）
```
system:user:edit:username
system:user:edit:email
system:user:edit:phonenumber
```

**适中**：按功能设置权限（推荐）
```
system:user:edit
```

#### 3. 数据权限与业务权限分离

```java
// 业务权限检查
@PreAuthorize("@ss.hasPermi('system:user:list')")

// 数据权限过滤
@DataScope(deptAlias = "d")
public List<SysUser> selectList(SysUser user) { }
```

#### 4. 避免权限绕过

**错误示例**（缺少权限检查）：
```java
@GetMapping("/list")
public TableDataInfo list(SysUser user) {
    // 没有 @PreAuthorize 注解
    List<SysUser> list = userService.selectList(user);
    return getDataTable(list);
}
```

**正确示例**：
```java
@PreAuthorize("@ss.hasPermi('system:user:list')")
@GetMapping("/list")
public TableDataInfo list(SysUser user) {
    List<SysUser> list = userService.selectList(user);
    return getDataTable(list);
}
```

#### 5. 记录敏感操作日志

```java
@Log(title = "用户管理", businessType = BusinessType.DELETE)
@PreAuthorize("@ss.hasPermi('system:user:remove')")
@DeleteMapping("/{ids}")
public AjaxResult remove(@PathVariable Long[] ids) {
    return toAjax(userService.deleteUserByIds(ids));
}
```

---

## 附录

### A. 完整权限列表示例

```
# 系统管理
system:user:list          # 用户列表
system:user:query         # 用户查询
system:user:add           # 用户新增
system:user:edit          # 用户编辑
system:user:remove        # 用户删除
system:user:export        # 用户导出
system:user:import        # 用户导入
system:user:resetPwd      # 重置密码

system:role:list          # 角色列表
system:role:query         # 角色查询
system:role:add           # 角色新增
system:role:edit          # 角色编辑
system:role:remove        # 角色删除
system:role:export        # 角色导出

system:menu:list          # 菜单列表
system:menu:query         # 菜单查询
system:menu:add           # 菜单新增
system:menu:edit          # 菜单编辑
system:menu:remove        # 菜单删除

system:dept:list          # 部门列表
system:dept:query         # 部门查询
system:dept:add           # 部门新增
system:dept:edit          # 部门编辑
system:dept:remove        # 部门删除

system:post:list          # 岗位列表
system:post:query         # 岗位查询
system:post:add           # 岗位新增
system:post:edit          # 岗位编辑
system:post:remove        # 岗位删除
system:post:export        # 岗位导出

system:dict:list          # 字典列表
system:dict:query         # 字典查询
system:dict:add           # 字典新增
system:dict:edit          # 字典编辑
system:dict:remove        # 字典删除
system:dict:export        # 字典导出

system:config:list        # 参数列表
system:config:query       # 参数查询
system:config:add         # 参数新增
system:config:edit        # 参数编辑
system:config:remove      # 参数删除
system:config:export      # 参数导出

system:notice:list        # 通知列表
system:notice:query       # 通知查询
system:notice:add         # 通知新增
system:notice:edit        # 通知编辑
system:notice:remove      # 通知删除

# 系统监控
monitor:online:list       # 在线用户列表
monitor:online:query      # 在线用户查询
monitor:online:forceLogout # 强制退出

monitor:job:list          # 定时任务列表
monitor:job:query         # 定时任务查询
monitor:job:add           # 定时任务新增
monitor:job:edit          # 定时任务编辑
monitor:job:remove        # 定时任务删除
monitor:job:changeStatus  # 任务状态修改

monitor:operlog:list      # 操作日志列表
monitor:operlog:query     # 操作日志查询
monitor:operlog:remove    # 操作日志删除
monitor:operlog:export    # 操作日志导出

monitor:logininfor:list   # 登录日志列表
monitor:logininfor:query  # 登录日志查询
monitor:logininfor:remove # 登录日志删除
monitor:logininfor:export # 登录日志导出
monitor:logininfor:unlock # 账户解锁

# 系统工具
tool:gen:list             # 代码生成列表
tool:gen:query            # 代码生成查询
tool:gen:import           # 导入表
tool:gen:preview          # 预览代码
tool:gen:edit             # 编辑配置
tool:gen:remove           # 删除配置
tool:gen:code             # 生成代码
```

### B. 数据表结构说明

#### sys_user（用户表）

| 字段 | 类型 | 说明 |
|------|------|------|
| user_id | bigint | 用户ID（主键） |
| dept_id | bigint | 部门ID |
| user_name | varchar(30) | 用户账号 |
| nick_name | varchar(30) | 用户昵称 |
| user_type | varchar(2) | 用户类型（00系统用户） |
| email | varchar(50) | 邮箱 |
| phonenumber | varchar(11) | 手机号 |
| sex | char(1) | 性别（0男 1女 2未知） |
| avatar | varchar(100) | 头像路径 |
| password | varchar(100) | 密码（BCrypt加密） |
| status | char(1) | 状态（0正常 1停用） |
| del_flag | char(1) | 删除标志（0存在 2删除） |
| login_ip | varchar(128) | 最后登录IP |
| login_date | datetime | 最后登录时间 |

#### sys_role（角色表）

| 字段 | 类型 | 说明 |
|------|------|------|
| role_id | bigint | 角色ID（主键） |
| role_name | varchar(30) | 角色名称 |
| role_key | varchar(100) | 角色权限字符串 |
| role_sort | int | 显示顺序 |
| data_scope | char(1) | 数据权限范围（1-5） |
| menu_check_strictly | tinyint(1) | 菜单树选择关联显示 |
| dept_check_strictly | tinyint(1) | 部门树选择关联显示 |
| status | char(1) | 状态（0正常 1停用） |
| del_flag | char(1) | 删除标志（0存在 2删除） |

#### sys_menu（菜单表）

| 字段 | 类型 | 说明 |
|------|------|------|
| menu_id | bigint | 菜单ID（主键） |
| menu_name | varchar(50) | 菜单名称 |
| parent_id | bigint | 父菜单ID（0为根菜单） |
| order_num | int | 显示顺序 |
| path | varchar(200) | 路由地址 |
| component | varchar(255) | 组件路径 |
| route_name | varchar(50) | 路由名称 |
| query | varchar(255) | 路由参数 |
| is_frame | int | 是否外链（0是 1否） |
| is_cache | int | 是否缓存（0缓存 1不缓存） |
| menu_type | char(1) | 菜单类型（M目录 C菜单 F按钮） |
| visible | char(1) | 显示状态（0显示 1隐藏） |
| status | char(1) | 菜单状态（0正常 1停用） |
| perms | varchar(100) | 权限标识 |
| icon | varchar(100) | 菜单图标 |

#### sys_user_role（用户角色关联表）

| 字段 | 类型 | 说明 |
|------|------|------|
| user_id | bigint | 用户ID |
| role_id | bigint | 角色ID |

**主键**：(user_id, role_id)

#### sys_role_menu（角色菜单关联表）

| 字段 | 类型 | 说明 |
|------|------|------|
| role_id | bigint | 角色ID |
| menu_id | bigint | 菜单ID |

**主键**：(role_id, menu_id)

#### sys_role_dept（角色部门关联表）

| 字段 | 类型 | 说明 |
|------|------|------|
| role_id | bigint | 角色ID |
| dept_id | bigint | 部门ID |

**主键**：(role_id, dept_id)

---

## 联系方式

如有问题或建议，请联系系统管理员或提交Issue。

---

**文档版本**：1.0
**最后更新**：2025-11-27
**适用版本**：有康(YouKang) 3.9.0
