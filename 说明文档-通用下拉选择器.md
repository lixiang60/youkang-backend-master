# 通用选择器（Common Selector）使用说明

## 概述

通用选择器是一个为前端下拉框提供统一数据接口的组件系统。它使用策略模式 + 工厂模式实现，支持不同类型的选择器和模糊查询功能。

## 功能特点

- 统一的接口设计，前端只需调用一个接口
- 支持多种选择器类型（用户、部门、角色、岗位、字典等）
- 支持模糊查询
- 支持分页限制
- 易于扩展，可以轻松添加新的选择器类型

## 架构设计

### 核心组件

1. **SelectorDTO** - 通用返回数据结构
   - `label`: 显示标签
   - `value`: 实际值
   - `extra`: 扩展信息（完整对象）

2. **SelectorQueryReq** - 查询请求参数
   - `type`: 选择器类型
   - `keyword`: 模糊查询关键字
   - `param`: 额外参数（如字典类型）
   - `pageSize`: 分页大小（默认20）

3. **ICommonSelector** - 选择器接口
   - 所有选择器实现类都需要实现此接口

4. **SelectorFactory** - 选择器工厂
   - 根据类型获取对应的选择器实现

5. **CommonSelectorController** - 统一接口控制器
   - 提供统一的REST API接口

## 已支持的选择器类型

| 类型代码 | 说明 | 关键字搜索字段 | 额外参数 |
|---------|------|--------------|---------|
| user    | 用户选择器 | 用户名、昵称 | - |
| dept    | 部门选择器 | 部门名称 | - |
| role    | 角色选择器 | 角色名称 | - |
| post    | 岗位选择器 | 岗位名称 | - |
| dict    | 字典选择器 | 字典标签、字典值 | dictType（必填） |

## API 接口

### 1. GET方式查询选择器数据

**接口地址：** `/common/selector/list`

**请求方式：** GET

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| type | String | 是 | 选择器类型（user/dept/role/post/dict） |
| keyword | String | 否 | 模糊查询关键字 |
| param | String | 否 | 额外参数（字典类型需要传入dictType） |
| pageSize | Integer | 否 | 分页大小，默认20 |

**返回示例：**

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": [
    {
      "label": "管理员(admin)",
      "value": "1",
      "extra": { ...完整用户对象... }
    },
    {
      "label": "测试用户(test)",
      "value": "2",
      "extra": { ...完整用户对象... }
    }
  ]
}
```

**使用示例：**

```javascript
// 1. 查询用户列表
GET /common/selector/list?type=user

// 2. 模糊查询包含"张"的用户
GET /common/selector/list?type=user&keyword=张

// 3. 查询部门列表
GET /common/selector/list?type=dept

// 4. 查询特定字典类型的数据（如：性别字典）
GET /common/selector/list?type=dict&param=sys_user_sex

// 5. 限制返回10条
GET /common/selector/list?type=role&pageSize=10
```

### 2. POST方式查询选择器数据

**接口地址：** `/common/selector/list`

**请求方式：** POST

**请求体：**

```json
{
  "type": "user",
  "keyword": "张",
  "param": null,
  "pageSize": 20
}
```

**返回格式：** 同GET方式

### 3. 获取支持的选择器类型

**接口地址：** `/common/selector/types`

**请求方式：** GET

**返回示例：**

```json
{
  "code": 200,
  "msg": "操作成功",
  "data": ["dept", "dict", "post", "role", "user"]
}
```

## 前端使用示例

### Vue 3 + Element Plus 示例

```vue
<template>
  <el-select
    v-model="selectedUser"
    filterable
    remote
    reserve-keyword
    placeholder="请选择用户"
    :remote-method="searchUsers"
    :loading="loading"
  >
    <el-option
      v-for="item in userOptions"
      :key="item.value"
      :label="item.label"
      :value="item.value"
    />
  </el-select>
</template>

<script setup>
import { ref } from 'vue'
import axios from 'axios'

const selectedUser = ref('')
const userOptions = ref([])
const loading = ref(false)

const searchUsers = async (keyword) => {
  loading.value = true
  try {
    const { data } = await axios.get('/common/selector/list', {
      params: {
        type: 'user',
        keyword: keyword || '',
        pageSize: 20
      }
    })
    if (data.code === 200) {
      userOptions.value = data.data
    }
  } finally {
    loading.value = false
  }
}

// 初始加载
searchUsers('')
</script>
```

### React 示例

```jsx
import React, { useState, useEffect } from 'react';
import { Select } from 'antd';
import axios from 'axios';

const UserSelector = () => {
  const [options, setOptions] = useState([]);
  const [loading, setLoading] = useState(false);

  const fetchUsers = async (keyword = '') => {
    setLoading(true);
    try {
      const { data } = await axios.get('/common/selector/list', {
        params: {
          type: 'user',
          keyword,
          pageSize: 20
        }
      });
      if (data.code === 200) {
        setOptions(data.data);
      }
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchUsers();
  }, []);

  return (
    <Select
      showSearch
      placeholder="请选择用户"
      loading={loading}
      onSearch={fetchUsers}
      filterOption={false}
      options={options}
    />
  );
};
```

## 如何扩展新的选择器

假设你需要添加一个"客户"选择器，步骤如下：

### 1. 在枚举中添加新类型

编辑 `SelectorTypeEnum.java`：

```java
/**
 * 客户选择器
 */
CUSTOMER("customer", "客户选择器"),
```

### 2. 创建选择器实现类

创建 `CustomerSelectorImpl.java`：

```java
package com.youkang.framework.web.service.selector.impl;

import com.youkang.common.core.domain.SelectorDTO;
import com.youkang.common.core.domain.SelectorQueryReq;
import com.youkang.common.enums.SelectorTypeEnum;
import com.youkang.common.utils.StringUtils;
import com.youkang.framework.web.service.selector.ICommonSelector;
import com.youkang.system.service.ICustomerService;  // 假设你有这个服务
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;

@Service
public class CustomerSelectorImpl implements ICommonSelector {

    @Autowired
    private ICustomerService customerService;

    @Override
    public List<SelectorDTO> getSelectorList(SelectorQueryReq queryReq) {
        // 构建查询条件
        Customer customer = new Customer();
        if (StringUtils.isNotEmpty(queryReq.getKeyword())) {
            customer.setCustomerName(queryReq.getKeyword());
        }

        // 查询数据
        List<Customer> customerList = customerService.selectCustomerList(customer);

        // 限制返回数量
        if (queryReq.getPageSize() != null && queryReq.getPageSize() > 0) {
            customerList = customerList.stream()
                    .limit(queryReq.getPageSize())
                    .collect(Collectors.toList());
        }

        // 转换为SelectorDTO
        return customerList.stream()
                .map(c -> new SelectorDTO(
                        c.getCustomerName(),                    // label
                        String.valueOf(c.getCustomerId()),      // value
                        c                                       // extra
                ))
                .collect(Collectors.toList());
    }

    @Override
    public String getSelectorType() {
        return SelectorTypeEnum.CUSTOMER.getCode();
    }
}
```

### 3. 使用新的选择器

```javascript
// 前端调用
GET /common/selector/list?type=customer&keyword=有康
```

就这么简单！Spring会自动扫描并注册你的实现类到工厂中。

## 注意事项

1. **字典选择器特殊性**：使用字典选择器时，必须通过`param`参数传入字典类型（dictType）
   ```
   GET /common/selector/list?type=dict&param=sys_user_sex
   ```

2. **分页限制**：`pageSize`参数只是限制返回数量，并不是真正的数据库分页。如果需要支持大数据量场景，建议在具体的Selector实现中添加真正的分页逻辑。

3. **权限控制**：当前接口未添加权限注解，如需要权限控制，可在Controller方法上添加 `@PreAuthorize` 注解。

4. **性能优化**：对于高频调用的选择器，建议在实现类中添加缓存逻辑（如使用Redis）。

5. **extra字段使用**：extra字段包含完整的业务对象，前端可根据需要使用其中的额外信息，但要注意避免敏感信息泄露（如密码等）。

## 文件清单

```
youkang-common/
  └── src/main/java/com/youkang/common/
      ├── core/domain/
      │   ├── SelectorDTO.java              # 通用选择器DTO
      │   └── SelectorQueryReq.java         # 查询请求类
      └── enums/
          └── SelectorTypeEnum.java          # 选择器类型枚举

youkang-framework/
  └── src/main/java/com/youkang/framework/web/service/selector/
      ├── ICommonSelector.java              # 选择器接口
      ├── SelectorFactory.java              # 选择器工厂
      └── impl/
          ├── UserSelectorImpl.java         # 用户选择器实现
          ├── DeptSelectorImpl.java         # 部门选择器实现
          ├── RoleSelectorImpl.java         # 角色选择器实现
          ├── PostSelectorImpl.java         # 岗位选择器实现
          └── DictSelectorImpl.java         # 字典选择器实现

youkang-admin/
  └── src/main/java/com/youkang/web/controller/common/
      └── CommonSelectorController.java     # 统一接口控制器
```

## 总结

通用选择器组件提供了一个简洁、统一、可扩展的下拉框数据接口解决方案。通过策略模式的设计，可以轻松添加新的选择器类型，同时保持前端调用接口的一致性。
